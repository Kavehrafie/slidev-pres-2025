// scripts/generate-auth-config.js
import fs from "fs";
import path from "path";
import yaml from "js-yaml";

const yamlPath = path.resolve("auth_config.yaml");
const outputPath = path.resolve("functions", "auth_config.js");
const outputDir = path.dirname(outputPath);

try {
  // Ensure output directory exists
  if (!fs.existsSync(outputDir)) {
    fs.mkdirSync(outputDir, { recursive: true });
  }

  // Read YAML file
  const yamlContent = fs.readFileSync(yamlPath, "utf8");
  const config = yaml.load(yamlContent);

  // Generate JavaScript module content
  // Ensure environment variable placeholders are kept as strings for replacement later
  const stringifiedConfig = JSON.stringify(
    config,
    (key, value) => {
      if (typeof value === "string" && value.startsWith("$")) {
        // Remove the leading '$' to get the actual environment variable name
        return value.substring(1);
      }
      return value;
    },
    2,
  );

  const jsContent = `// Generated from auth_config.yaml by scripts/generate-auth-config.js
// Do not edit this file directly.

export const authConfig = ${stringifiedConfig};
`;

  // Write JavaScript file
  fs.writeFileSync(outputPath, jsContent, "utf8");
  console.log(`Successfully generated ${outputPath} from ${yamlPath}`);
} catch (error) {
  console.error("Error generating auth config:", error);
  process.exit(1); // Exit with error code
}
